function Add(){}function Brush(){}function Cut(){}function Eraser(){}function Move(){this.startPos=null,this.currentPos=null,this.updateTime=null,this.updateInterval=100,this.cursor="move"}function Rotate(){}function run(){for(var a of geometryUpdates)updateGeometries(a);geometryUpdates.clear(),positionUpdate&&(updatePositions(),expandSheet(),positionUpdate=!1),statsUpdate&&(updateRingStats(),statsUpdate=!1),requestAnimationFrame(run),renderer.render(scene,camera)}function onSignIn(a){var b=a.getBasicProfile();userID=b.getId(),id_token=a.getAuthResponse().id_token,updateSaveButton(),$("div.g-signin2").text("Signed in as: "+b.getEmail()),$("div.abcRioButton").css("display","none")}function chooseWeave(){$(document).on("change","#weave",function(a){if(!$(this).val())return void a.preventDefault();$("div#weave-select").html("Loading weave...");var b=$(this).val();$.ajax({url:envSettings.useLocalData?"/data/weave/"+b:envSettings.host+"/data/getweave?name="+b,dataType:"json",success:function(a){$.featherlight.close(),weave=a,weave.file=b,setupWeave()}})}),$.featherlight($("div#weave-select").css("display","block").remove(),{closeOnClick:!1,closeOnEsc:!1})}function updateSaveButton(){key&&!authorID||!userID||($("#save-button").attr("disabled",!1),key&&authorID!==userID&&$("#save-button").attr("value","Save a copy"))}function getClickedRing(){raycaster.setFromCamera(mouse.pos,camera);var a=raycaster.intersectObjects(scene.children);return a=a.length>0&&ringEnabledFlags[ringGraph.node(a[0].object.nodeID).geometryIndex]?ringGraph.node(a[0].object.nodeID):null}function loadStaticData(){if(envSettings.useLocalData){var a=["awg.json","swg.json"],c=[];$(a).each(function(){var a=this;c.push($.ajax({url:"/data/wire/"+a,success:function(a){"string"==typeof a&&(a=JSON.parse(a)),a.name&&a.sizes&&(wireGauges[a.name]=a)}}))}),$.when.apply(this,c).done(function(){setupRingDivs()}),c.push($.ajax({url:"/data/wire/materials.json",success:function(a){wireMaterials="string"==typeof a?JSON.parse(a):a}})),c.push($.ajax({url:"/data/weave/weaves.json",success:function(a){weaves="string"==typeof a?JSON.parse(a):a}})),$.when.apply(this,c).done(function(){var a=$("#weave");weaves.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),a.append("<option value=''>----</option>");for(var b=0;b<weaves.length;b++){var c=weaves[b];a.append("<option value='"+c.file+"'>"+c.name+"</option>")}key?loadSheetData(key):chooseWeave()})}else $.ajax({url:envSettings.host+"data/getwires",dataType:"json",success:function(a){for(var b=0;b<a.length;b++){var c=a[b];wireGauges[c.name]=c}setupRingDivs(),$.ajax({url:envSettings.host+"data/getweaveslist",dataType:"json",success:function(a){var b=$("#weave");a.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),b.append("<option value=''>----</option>");for(var c=0;c<a.length;c++){var d=a[c];b.append("<option value='"+d.file+"'>"+d.name+"</option>")}b.change()},error:function(a){console.log(a)}})}})}function loadSheetData(a){geometryUpdates=new Set;$.ajax({url:"/datastore/load",data:{key:a},success:function(a){nodeIndex=0,edgeRings=new Set,geometryUpdates=new Set,a=JSON.parse(a),authorID=a.authorID,$.ajax({url:envSettings.useLocalData?"/data/weave/"+a.weave:envSettings.host+"/data/getweave?name="+a.weave,dataType:"json",success:function(b){weave=b,weave.file=a.weave,setupWeave(),createRings();for(var c of JSON.parse(a.rings)){var d=new Ring(c);d.mesh.position.copy(c.position),d.mesh.rotation.copy(c.rotation),d.changeColor(c.color)}units!==a.units&&(units=a.units,changeUnits());for(var e of JSON.parse(a.edgeRings))edgeRings.add(ringGraph.node(e));updateSaveButton()}})},error:function(a){console.log(a)}})}function Ring(a){if(a.ringID){var b=weave.structure[a.ringID];this.ringIndex=b.ring}else a.ringIndex&&(this.ringIndex=a.ringIndex);var c=weave.rings[this.ringIndex];this.geometryIndex=c.geometry,this.mesh=new THREE.Mesh(baseGeometries[this.geometryIndex],baseMaterials[this.geometryIndex]);var d=this.mesh.geometry.parameters.radius,e=this.mesh.geometry.parameters.tube/2;if(a.ringID){var f=d+e;a.basePos&&this.mesh.position.copy(a.basePos),this.mesh.position.x+=f*b.pos.x,this.mesh.position.y+=f*b.pos.y,this.mesh.position.z=-50,this.mesh.position.z+=f*(b.pos.z?b.pos.z:0);var g=!1;a.ringID in structureRotations&&(this.mesh.quaternion.copy(structureRotations[a.ringID]),g=!0),ringRotations[this.ringIndex]&&(g?this.mesh.quaternion.multiply(ringRotations[this.ringIndex]):this.mesh.quaternion.copy(ringRotations[this.ringIndex]))}this.mesh.material.transparent=!ringEnabledFlags[this.geometryIndex],this.mesh.material.opacity=ringEnabledFlags[this.geometryIndex]?1:.5,this.updated=!1,this.isInCamera=function(a){return a||(a=new THREE.Frustum,camera.updateMatrixWorld(),a.setFromMatrix((new THREE.Matrix4).multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse))),a.intersectsObject(this.mesh)},this.toJSON=function(){var a={};for(var b in this)"mesh"!==b&&"updated"!==b&&("string"==typeof this[b]?a[b]=this[b]:"function"==typeof this[b].toJSON?a[b]=this[b].toJSON():a[b]=JSON.stringify(this[b]));return a.color="#"+this.mesh.material.color.getHexString(),a.position=this.mesh.position,a.rotation=this.mesh.rotation,a},this.changeColor=function(a){var b="#"+this.mesh.material.color.getHexString();if(a)"string"==typeof a?(a=("#"!==a[0]?"#":"")+a,this.mesh.material=getMaterial(a),Ring.colorCounts[this.geometryIndex][a]++,Ring.colorCounts[this.geometryIndex][b]--):a instanceof THREE.Color&&this.changeColor(a.getHexString());else{this.mesh.material=baseMaterials[this.geometryIndex];var c="#"+this.mesh.material.color.getHexString();Ring.colorCounts[this.geometryIndex][b]--,Ring.colorCounts[this.geometryIndex][c]++}statsUpdate=!0},Object.defineProperties(this,{volume:{get:function(){return Math.PI*d*d*2*Math.PI*e/("mm"===units?1e9:1)/(scale*scale*scale)}},visible:{set:function(a){this.mesh.visible=a,Ring.colorCounts[this.geometryIndex]["#"+this.mesh.material.color.getHexString()]+=a?1:-1,statsUpdate=!0}}}),scene.add(this.mesh),this.nodeIndex=nodeIndex,this.nodeID="ring-"+nodeIndex,this.mesh.nodeID=this.nodeID,ringGraph.setNode(this.nodeID,this),nodeIndex++,Ring.colorCounts[this.geometryIndex]["#"+this.mesh.material.color.getHexString()]++,statsUpdate=!0}function linkRings(a,b){if(a.mesh.updateMatrixWorld(),!a.isInCamera(b))return void edgeRings.add(a);var c,f,d=weave.structure,e=weave.linkPaths;for(c in d)if(d[c].base){f=c;break}if(f){var g={base:a},h=function(a){return a.name===l};for(c in g)if("links"in d[c])for(var i=0;i<d[c].links.length;i++){var j=d[c].links[i];if(j){var k="object"==typeof j?j.id:j,l="object"==typeof j?j.as:j;if(!(l in g)){var m=ringGraph.outEdges(g[c].nodeID).filter(h);if(m.length>0){var n=ringGraph.node(m[0].w);g[l]=n}}}}h=function(a){return a.name===p[i]};for(var o in e)if(!(o in g))for(var p of e[o])if(0!==p.length){for(var q=!0,r=a,i=0;q&&i<p.length;i++){var m=ringGraph.outEdges(r.nodeID).filter(h);q=q&&m.length>0,q&&(r=ringGraph.node(m[0].w))}q&&(ringGraph.setEdge(a.nodeID,r.nodeID,o,o),g[o]=r)}var s=[];for(c in d)if(!(c in g)){var t=new Ring({ringID:c,basePos:a.mesh.position});g[c]=t,s.push(t)}for(c in g)if("links"in d[c])for(var i=0;i<d[c].links.length;i++){var j=d[c].links[i];if(j){var k="object"==typeof j?j.id:j,l="object"==typeof j?j.as:j;k in g&&!ringGraph.hasEdge(g[c].nodeID,g[k].nodeID,l)&&ringGraph.setEdge(g[c].nodeID,g[k].nodeID,l,l)}}if(0!==s.length){edgeRings.delete(a);for(c in g){var u=g[c].ringIndex;if(c!==f&&weave.rings[u].base){var v=linkRings(g[c],b);v&&v.length>0&&(s=s.concat(v))}}return s}}}function createRings(){if(weave&&0!==Object.keys(wireGauges).length){for(var a=performance.now(),b=0;b<weave.geometries.length;b++){var c=$("div#ring-div-"+b+" .inner-diameter").val()*scale/2,d=getSelectedWireGauge(b)*scale,e=$("div#ring-div-"+b).find(".default-color").val();baseGeometries[b]=new THREE.TorusGeometry(c,d,radialSegments,tubularSegments),baseMaterials[b]=new THREE.MeshPhongMaterial({color:e,specular:e,shininess:60,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),Ring.colorCounts[b][e]=0}ringRotations=[];for(var b=0;b<weave.rings.length;b++)weave.rings[b].rotation?ringRotations[b]=(new THREE.Quaternion).setFromAxisAngle(THREE.Vector3.y_axis,THREE.Math.degToRad(weave.rings[b].rotation)):ringRotations[b]=null;structureRotations={};for(var f in weave.structure){var g=weave.structure[f];if(g.rot){var h=new THREE.Quaternion;g.rot.x&&h.multiply((new THREE.Quaternion).setFromAxisAngle(THREE.Vector3.x_axis,THREE.Math.degToRad(g.rot.x))),g.rot.y&&h.multiply((new THREE.Quaternion).setFromAxisAngle(THREE.Vector3.y_axis,THREE.Math.degToRad(g.rot.y))),g.rot.z&&h.multiply((new THREE.Quaternion).setFromAxisAngle(THREE.Vector3.z_axis,THREE.Math.degToRad(g.rot.z))),structureRotations[f]=h}}var i=new Ring({ringID:"base"}),j=new THREE.Frustum;camera.updateMatrixWorld(),j.setFromMatrix((new THREE.Matrix4).multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse)),linkRings(i,j),envSettings.logPerformance&&(console.log("children: "+scene.children.length),console.log("creation time: "+(performance.now()-a).toFixed(2)));for(var b=0;b<weave.geometries.length;b++)updateRingStats(b)}}function updateGeometry(a,b){if(!a.updated){b&&a.geometryIndex!==b||(a.mesh.geometry=baseGeometries[a.geometryIndex],a.mesh.geometry.dynamic=!0,a.mesh.geometry.verticesNeedUpdate=!0),a.updated=!0;var c=ringGraph.outEdges(a.nodeID);if(c)for(var d=0;d<c.length;d++)updateGeometry(ringGraph.node(c[d].w),b)}}function updateGeometries(a){if(weave&&0!==Object.keys(wireGauges).length){if(null===ringGraph||0===ringGraph.nodeCount())return void createRings();var b=performance.now(),c=ringGraph.node(ringGraph.nodes()[0]);baseGeometries[a]&&baseGeometries[a].dispose();var d=$("div#ring-div-"+a+" .inner-diameter").val()*scale/2,e=getSelectedWireGauge(a)*scale;baseGeometries[a]=new THREE.TorusGeometry(d,e,radialSegments,tubularSegments),updateGeometry(c,a),resetRingFlag(c);var f=performance.now();envSettings.logPerformance&&(console.log("children: "+scene.children.length),console.log("update geometry time: "+(f-b).toFixed(2)))}}function updatePosition(a,b,c){if(!a.updated){var d=weave.structure[b],e=a.mesh.geometry.parameters.radius+a.mesh.geometry.parameters.tube/2;c&&a.mesh.position.copy(c),a.mesh.position.x+=e*d.pos.x,a.mesh.position.y+=e*d.pos.y,a.mesh.position.z=-50,a.mesh.position.z+=e*(d.pos.z?d.pos.z:0),a.updated=!0;var f=ringGraph.outEdges(a.nodeID);if(f)for(var g=0;g<f.length;g++)updatePosition(ringGraph.node(f[g].w),f[g].name,a.mesh.position)}}function updatePositions(){var c,a=ringGraph.node(ringGraph.nodes()[0]),b=weave.structure;for(var d in b)if(b[d].base){c=d;break}c&&(updatePosition(a,"base"),resetRingFlag(a))}function resetRingFlag(a){if(a.updated){a.updated=!1;var b=ringGraph.outEdges(a.nodeID);if(b)for(var c=0;c<b.length;c++)resetRingFlag(ringGraph.node(b[c].w))}}function setupRingDivs(){$("div.ring-div").each(function(){var a=$(this).data("geometry");$(this).prepend("<h4>Ring type #"+(a+1)+"</h4>");var b=$(this).find(".ring-enable").attr("id","ring-enable-"+a);b.next("label").attr("for","ring-enable-"+a).css("width",b.css("width")).css("height",b.css("height"));var c=$(this).find(".wire-gauge-system"),d="",e=weave.geometries[a];e.defaults&&e.defaults.wireSystem&&(d=e.defaults.wireSystem);for(var f in wireGauges){var g=wireGauges[f];c.append("<option value='"+g.name+"'"+(g.name===d?"selected":"")+">"+g.name+"</option>")}c.data("value",c.val()).change();var h=$(this).find(".wire-gauge");h.data("value",h.val()),e.defaults&&e.defaults.wireGauge&&h.val(e.defaults.wireGauge).change();var i=$(this).find(".wire-material");for(var j of Object.keys(wireMaterials).sort(function(a,b){return a.localeCompare(b)}))i.append("<option value='"+j+"'>"+j+"</option>");var k=$(this).find(".inner-diameter");e.defaults&&e.defaults.innerDiameter&&k.val(e.defaults.innerDiameter);var l=$(this).find(".aspect-ratio"),m=Math.max(e.minAR?e.minAR:Number.NEGATIVE_INFINITY,k.attr("min")/getSelectedWireGauge(a));l.attr("min",m),k.attr("min",m*getSelectedWireGauge(a));var n=Math.min(e.maxAR?e.maxAR:Number.POSITIVE_INFINITY,k.attr("max")/getSelectedWireGauge(a));l.attr("max",n),k.attr("max",n*getSelectedWireGauge(a));var o={minClass:"slider-min unit-field",maxClass:"slider-max unit-field",valueClass:"slider-value unit-field",bubble:!1};k.boundedSlider(o),l.boundedSlider(o),k.val(Number(k.val()).toFixed(2)).change(),l.change()})}function getSelectedWireGauge(a){return wireGauges[$("div#ring-div-"+a+" .wire-gauge-system").val()].sizes[$("div#ring-div-"+a+" .wire-gauge").val()][units]}function createWireGaugeList(a,b){var c=wireGauges[b],d=$("div#ring-div-"+a+" .wire-gauge"),e=d.val();d.html("");for(var f in c.sizes)d.append("<option value='"+f+"'"+(f===e?"selected":"")+">"+f+" - "+c.sizes[f][units]+" "+units+".</option>")}function updateID(a){var b=$("div#ring-div-"+a),c=b.find(".aspect-ratio"),d=c.val()*getSelectedWireGauge(a);b.find(".inner-diameter").val(d).trigger("update"),positionUpdate=!0}function updateAR(a){var b=$("div#ring-div-"+a),c=b.find(".inner-diameter"),d=c.val()/getSelectedWireGauge(a),e=weave.geometries[a],f=Math.max(e.minAR?e.minAR:Number.NEGATIVE_INFINITY,c.attr("min")/getSelectedWireGauge(a)),g=Math.min(e.maxAR?e.maxAR:Number.POSITIVE_INFINITY,c.attr("max")/getSelectedWireGauge(a));d<f&&(d=f,c.val(d*getSelectedWireGauge(a)).change()),d>g&&(d=g,c.val(d*getSelectedWireGauge(a)).change()),b.find(".aspect-ratio").attr("min",f).attr("max",g).val(d).trigger("update"),positionUpdate=!0}function expandSheet(){var a=new THREE.Frustum;camera.updateMatrixWorld(),a.setFromMatrix((new THREE.Matrix4).multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse));for(var b of edgeRings)linkRings(b,a);statsUpdate=!0}function setupWeave(){camera.position.x=0,camera.position.y=0,camera.position.z=1e3,camera.zoom=1,camera.updateMatrixWorld(),camera.updateProjectionMatrix(),ringGraph=new graphlib.Graph({directed:!0,multigraph:!0}),nodeIndex=0,edgeRings=new Set,geometryUpdates=new Set,Ring.colorCounts=[];for(var a=scene.children.length-1;a>=0;a--)scene.children[a]instanceof THREE.Camera||scene.children[a]instanceof THREE.Light||scene.remove(scene.children[a]);ringEnabledFlags=[];var b="values"in weave?weave.values:{};for(var c in weave.structure){var d=weave.structure[c];"values"in d&&(b=$.extend(b,d.values));for(var e in b)"string"==typeof b[e]&&(b[e]=Parser.evaluate(b[e],b));for(var f in d.pos)d.pos[f]=Parser.evaluate(""+d.pos[f],b);for(var f in d.rot)d.rot[f]=Parser.evaluate(""+d.rot[f],b)}$("div.ring-div").remove();for(var g=$("div#ring-div-div"),a=0;a<weave.geometries.length;a++)g.append(ringDiv.clone(!0).attr("id","ring-div-"+a).data("geometry",a)),ringEnabledFlags[a]=!0,Ring.colorCounts[a]={};setupRingDivs(),commandQueue=[],commandIndex=0,updateUndoRedoButtons()}function updateUndoRedoButtons(){commandQueue.length>0&&commandIndex>0?$("#undo-button").removeClass("disabled").attr("disabled",!1):$("#undo-button").addClass("disabled").attr("disabled",!0),commandQueue.length>0&&commandIndex<commandQueue.length?$("#redo-button").removeClass("disabled").attr("disabled",!1):$("#redo-button").addClass("disabled").attr("disabled",!0)}function executeCommand(a){a.execute(),commandQueue[commandIndex]=a,commandIndex++,commandQueue.length>commandIndex&&commandQueue.splice(commandIndex,commandQueue.length-commandIndex),updateUndoRedoButtons()}function undo(){commandIndex<=0||(commandIndex--,commandQueue[commandIndex].undo(),updateUndoRedoButtons())}function redo(){commandIndex>=commandQueue.length||(commandQueue[commandIndex].execute(),commandIndex++,updateUndoRedoButtons())}function print(){var a=camera.zoom,b={};for(var c of ringGraph.nodes()){var d=ringGraph.node(c),e="#"+d.mesh.material.color.getHexString();e in b||(b[e]=new THREE.MeshLambertMaterial({color:e})),d.mesh.material=b[e]}for(var f=new Set(edgeRings),g=0;g<2;g++)for(var d of f)for(var h of ringGraph.outEdges(d.nodeID))f.add(ringGraph.node(h.w));for(;camera.zoom>.1&&f.size>0;){camera.zoom*=.9,camera.updateProjectionMatrix();var i=new THREE.Frustum;camera.updateMatrixWorld(),i.setFromMatrix((new THREE.Matrix4).multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse));for(var d of f)d.isInCamera(i)&&f.delete(d)}camera.zoom*=.8,camera.updateProjectionMatrix(),renderer.render(scene,camera);var j=canvas.toDataURL(),k="<!DOCTYPE html>";k+="<html>",k+="<head><title>Print canvas</title>",k+='<style type="text/css">',k+="\tp {",k+="\t\tfont-size: 1rem;",k+='\t\tfont-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;',k+="\t\tcolor: #222;",k+="\t}",k+="</style>",k+="</head>",k+="<body>",k+='<img src="'+j+'">',k+="<p>Generated by e-maille: e-maille.appspot.com</p>",k+="</body>",k+="</html>";try{var l=window.open("","","width="+$(window).width(),"height="+$(window).height());l.document.open(),l.document.write(k),l.document.close(),l.focus(),l.print(),l.close()}catch(a){console.log(a),alert("There was an error printing your sheet: \n"+a)}for(var c of ringGraph.nodes()){var d=ringGraph.node(c),e="#"+d.mesh.material.color.getHexString();d.mesh.material=getMaterial(e)}camera.zoom=a,camera.updateProjectionMatrix(),renderer.render(scene,camera)}function getMaterial(a){a in materials||(materials[a]=baseMaterials[0].clone(),materials[a].color.setStyle(a),materials[a].specular&&materials[a].specular.setStyle(a));for(var b=0;b<weave.geometries.length;b++)a in Ring.colorCounts[b]||(Ring.colorCounts[b][a]=0);return materials[a]}function updateRingStats(){$("div.ring-div").each(function(){var a=$(this).data("geometry"),b=$(this).find("table.ring-stats-table tbody"),c=Ring.colorCounts[a];b.find("tr").remove();for(var d of Object.keys(c).sort(function(a,b){return c[b]-c[a]})){if(0===Ring.colorCounts[a][d])break;b.append("<tr><td class='ring-color-button-cell'><input type='color' class='ring-color-button' value='"+d+"'/></td><td class='ring-color-text-cell'>"+d+"</td><td class='ring-count-cell'>"+c[d]+"</td></tr>")}var e;if(Object.values)e=Object.values(Ring.colorCounts[a]);else{e=[];for(var f in Ring.colorCounts[a])e.push(Ring.colorCounts[a][f])}for(var h,g=e.reduce(function(a,b){return a+b}),i=ringGraph.nodes(),j=0;!h&&j<i.length;j++)ringGraph.node(i[j]).geometryIndex===a&&(h=ringGraph.node(i[j]));var k=h.volume*g,l=$(this).find(".wire-material").val(),m=wireMaterials[l][units]*k;$(this).find(".weight-span").html(m.toFixed(2)+" "+("mm"===units?"kg.":"lbs."))})}function changeUnits(){"in"===units?($("input.unit-field").each(function(){$(this).val(($(this).val()/25.4).toFixed(2)),$(this).attr("min",$(this).attr("min")/25.4),$(this).attr("max",$(this).attr("max")/25.4)}),scale*=25.4):($("input.unit-field").each(function(){$(this).val((25.4*$(this).val()).toFixed(2)),$(this).attr("min",25.4*$(this).attr("min")),$(this).attr("max",25.4*$(this).attr("max"))}),scale/=25.4),$("div.ring-div").each(function(){createWireGaugeList($(this).data("geometry"),$(this).find(".wire-gauge-system").val())}),statsUpdate=!0}Add.prototype={relinkRing:function(a){var b=[],c=new Set;return{execute:function(){b=[],c=new Set;var d;if(weave.rings[a.ringIndex].base)d=a;else{var e;for(ringID in weave.structure)if(weave.structure[ringID].base){e=ringID;break}if(!e)return;var f=ringGraph.inEdges(a.nodeID).filter(function(a){return a.name===e});if(0===f.length)return;d=ringGraph.node(f[0].v)}for(var g of ringGraph.outEdges(d.nodeID)){var h=ringGraph.node(g.w);h.mesh.visible||(h.visible=!0,b.push(h),c.add(h.geometryIndex))}for(var i in c)updateRingStats(i)},undo:function(){for(var a of b)a.visible=!1;for(var d in c)updateRingStats(d)}}},onMouseDown:function(){var a=getClickedRing();if(null!==a)return this.relinkRing(a)},onMouseUp:function(){},onMouseMove:function(){if(mouse.down){var a=getClickedRing();if(null!==a)return this.relinkRing(a)}}},Brush.prototype={paintRing:function(a){var b=$("#ring-color").val(),c="#"+a.mesh.material.color.getHexString();return c===b?null:{execute:function(){a.changeColor(b)},undo:function(){a.changeColor(c)}}},onMouseDown:function(){var a=getClickedRing();if(null!==a)return this.paintRing(a)},onMouseUp:function(){},onMouseMove:function(){if(mouse.down){var a=getClickedRing();if(null!==a)return this.paintRing(a)}}},Cut.prototype={removeRing:function(a){return{execute:function(){a.visible=!1},undo:function(){a.visible=!0}}},onMouseDown:function(){var a=getClickedRing();if(null!==a)return this.removeRing(a)},onMouseUp:function(){},onMouseMove:function(){if(mouse.down){var a=getClickedRing();if(null!==a)return this.removeRing(a)}}},Eraser.prototype={eraseRing:function(a){var b="#"+a.mesh.material.color.getHexString(),c="#"+baseMaterials[a.geometryIndex].color.getHexString();return b===c?null:{execute:function(){a.changeColor()},undo:function(){a.changeColor(b)}}},onMouseDown:function(){var a=getClickedRing();if(null!==a)return this.eraseRing(a)},onMouseUp:function(){},onMouseMove:function(){if(mouse.down){var a=getClickedRing();if(null!==a)return this.eraseRing(a)}}},Move.prototype={onMouseDown:function(){this.startPos=mouse.pos.clone(),this.currentPos=mouse.pos.clone(),this.updateTime=performance.now()},onMouseUp:function(){expandSheet()},onMouseMove:function(){mouse.down&&(camera.position.x-=(mouse.pos.x-this.currentPos.x)*canvas.width/2,camera.position.y-=(mouse.pos.y-this.currentPos.y)*canvas.height/2,this.currentPos.copy(mouse.pos),performance.now()-this.updateTime>this.updateInterval&&(expandSheet(),this.updateTime=performance.now()))}},Rotate.prototype={onMouseDown:function(){return{execute:function(){camera.rotation.z+=THREE.Math.degToRad(30),expandSheet()},undo:function(){camera.rotation.z-=THREE.Math.degToRad(30)}}},onMouseUp:function(){},onMouseMove:function(){}},function(a){a("<style>").prop("type","text/css").html(".bounded-slider-input {\tborder-style: none;}.bounded-slider-value {\tposition: absolute;\twidth: 4%;\ttext-align: center;\tborder-radius: 10px;\tdisplay: inline-block;\tbackground-color: white;\tborder-color: black;\tborder-width: 1px;\tborder-style: solid;}").appendTo("head");var b=function(b,c){var d=this;if(this.elem=b,this.options=a.extend({decimals:2,bubble:!0},c),d.min=b.attr("min"),this.minSpan=a("<input readonly type='number' class='bounded-slider-input'></input>").val(Number(d.min).toFixed(d.options.decimals)),d.elem.before(d.minSpan),"minClass"in d.options&&d.minSpan.addClass(d.options.minClass),d.max=b.attr("max"),this.maxSpan=a("<input readonly type='number' class='bounded-slider-input'></input>").val(Number(d.max).toFixed(d.options.decimals)),d.elem.after(d.maxSpan),"maxClass"in d.options&&d.maxSpan.addClass(d.options.maxClass),this.valueSpan=a("<input readonly type='number' class='bounded-slider-value'></output>").val(Number(d.elem.val()).toFixed(d.options.decimals)),d.maxSpan.after(d.valueSpan),"valueClass"in d.options&&d.valueSpan.addClass(d.options.valueClass),d.options.bubble){var e=function(){var a=d.elem.position(),b=-d.valueSpan.width()/2,c=(d.elem.val()-d.elem.attr("min"))/(d.elem.attr("max")-d.elem.attr("min"));return c=Math.clamp(c,0,1)*d.elem.width()+b,a.left+c};d.valueSpan.css("left",e()),d.valueSpan.css("top",d.elem.position().top);var f=d.elem.closest("div");f.height(f.height()+d.valueSpan.height()/2).css("padding-top",f.css("padding-top").replace("px","")+d.valueSpan.height()+"px")}else{d.valueSpan.removeClass("bounded-slider-value"),d.valueSpan.attr("readonly",!1);var e=function(){return d.valueSpan.position().left};d.valueSpan.on("change",function(){d.elem.val(d.valueSpan.val()).trigger("input")})}d.elem.on("change",function(){d.valueSpan.val(Number(a(this).val()).toFixed(d.options.decimals)).css("left",e())}),d.elem.on("input",function(){d.valueSpan.val(Number(a(this).val()).toFixed(d.options.decimals)).css("left",e())}),d.elem.on("update",function(){d.minSpan.val(Number(a(this).attr("min")).toFixed(d.options.decimals)),d.maxSpan.val(Number(a(this).attr("max")).toFixed(d.options.decimals)),d.valueSpan.val(Number(a(this).val()).toFixed(d.options.decimals)).css("left",e())})};a.fn.boundedSlider=function(c){return this.filter("input[type='range']").each(function(){return a(this).attr("min")&&a(this).attr("max")?void a(this).data("boundedSlider",new b(a(this),c)):void console.log("Range input must have max and min to use boundedSlider: "+a(this).attr("id"))})}}(jQuery);var key,authorID,ringEnabledFlags,renderer=null,scene=null,camera=null,canvas=null,units="in",wireGauges={},weave=null,baseGeometries=[],baseMaterials=[],materials={};if(!wireMaterials)var wireMaterials;var ringRotations,structureRotations,ringDiv,ringGraph,nodeIndex,edgeRings,tool,previousTool,userID,id_token,scale=100,radialSegments=8,tubularSegments=64,raycaster=new THREE.Raycaster,geometryUpdates=new Set,positionUpdate=!1,statsUpdate=!1,mouse={down:!1,pos:new THREE.Vector2},commandQueue=[],commandIndex=0,envSettings=$.extend({logPerformance:!1,host:"https://e-maille.appspot.com/",useLocalData:!0},typeof localEnvSettings!=="undefined"?localEnvSettings:{});Math.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},THREE.Vector3.x_axis=new THREE.Vector3(1,0,0),THREE.Vector3.y_axis=new THREE.Vector3(0,1,0),THREE.Vector3.z_axis=new THREE.Vector3(0,0,1),Ring.colorCounts=[],$(document).ready(function(){ringDiv=$("div.ring-div"),ringDiv.remove(),canvas=document.getElementById("canvas");var a=$(canvas).position();if(null===canvas.getContext("webgl"))return void $("body").html("<p>WebGL is required to diplay e-maille. Try updating your graphics card drivers.</p>");renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:!0});var b=$("div#control-panel"),c=.975*($(window).width()-b.width()-b.css("margin-left").replace("px","")),d=Math.max(.9*$(window).height(),9*c/16);b.css("max-height",d),renderer.setSize(c,d),scene=new THREE.Scene,scene.background=new THREE.Color("white"),camera=new THREE.OrthographicCamera(c/-2,c/2,d/2,d/-2,1,1e4),camera.position.z=50,camera.minZoom=1/3,camera.maxZoom=2,scene.add(camera);var e=$("#zoom-input");e.attr("min",camera.minZoom).attr("max",camera.maxZoom).val(camera.zoom);var f=new THREE.DirectionalLight(16777215,1);f.position.set(0,0,1),scene.add(f),window.onresize=function(a){var c=.975*($(window).width()-$("div#control-panel").width()-$("div#control-panel").css("margin-left").replace("px","")),d=Math.max(.9*$(window).height(),9*c/16);b.css("max-height",d),renderer.setSize(c,d),camera.left=c/-2,camera.right=c/2,camera.top=d/2,camera.bottom=d/-2,camera.updateProjectionMatrix(),expandSheet()},canvas.onmousedown=function(a){a.preventDefault(),mouse.down=!0;var b=tool.onMouseDown();b&&executeCommand(b)},canvas.onmouseup=function(a){a.preventDefault(),mouse.down=!1;var b=tool.onMouseUp();b&&executeCommand(b)},canvas.onmousemove=function(b){b.preventDefault(),mouse.pos.x=(b.pageX-a.left)/canvas.width*2-1,mouse.pos.y=2*-((b.pageY-a.top)/canvas.height)+1;var c=tool.onMouseMove();c&&executeCommand(c)},canvas.onmouseleave=function(){mouse.down=!1,tool.onMouseUp()},canvas.oncontextmenu=function(a){a.preventDefault()},canvas.onwheel=function(a){a.preventDefault(),camera.zoom=Math.clamp(camera.zoom+a.wheelDelta/720,camera.minZoom,camera.maxZoom),camera.updateProjectionMatrix(),expandSheet(),e.val(camera.zoom)},e.on("input",function(){camera.zoom=Math.clamp($(this).val(),camera.minZoom,camera.maxZoom),camera.updateProjectionMatrix(),expandSheet()});var g=function(a){a.preventDefault(),e.val(Math.clamp(camera.zoom+a.originalEvent.wheelDelta/720,camera.minZoom,camera.maxZoom)),e.trigger("input")};e.on("mouseenter",function(){e.on("mousewheel",g)}),e.on("mouseleave",function(){e.off("mousewheel",g)}),document.onkeydown=function(a){a.altKey&&"Alt"===a.key&&(tool instanceof Move||mouse.down?a.preventDefault():(previousTool=$(tool).data("button-id"),$("#move-button").click()))},document.onkeyup=function(a){a.ctrlKey?"z"===a.key?undo():"y"===a.key&&redo():"Alt"===a.key?(previousTool?$("#"+previousTool).click():a.preventDefault(),previousTool=null):a.ctrlKey||a.shiftKey||a.altKey||("b"===a.key?$("#brush-button").click():"m"===a.key?$("#move-button").click():"e"===a.key?$("#eraser-button").click():"p"===a.key?(a.preventDefault(),print()):"x"===a.key?$("#cut-button").click():"a"===a.key?$("#add-button").click():"r"===a.key&&$("#rotate-button").click())},$("#undo-button").click(function(){undo()}),$("#redo-button").click(function(){redo()}),$("#print-button").click(function(){print()}),$("#brush-button").click(function(){tool instanceof Brush||(tool=new Brush)}),$("#eraser-button").click(function(){tool instanceof Eraser||(tool=new Eraser)}),$("#move-button").click(function(){tool instanceof Move||(tool=new Move)}),$("#rotate-button").click(function(){tool instanceof Rotate||(tool=new Rotate)}),$("#cut-button").click(function(){tool instanceof Cut||(tool=new Cut)}),$("#add-button").click(function(){tool instanceof Add||(tool=new Add)}),$("button.tool-button").click(function(){$("button.tool-button").removeClass("selected"),$(this).addClass("selected"),$(".sub-tool-div").css("display","none").removeClass("selected"),$("#"+$(this).attr("id")+"-sub-tool-div").addClass("selected").css("display",""),$("#sub-tool-div-div").css("display",$(".sub-tool-div.selected").length>0?"":"none"),$(canvas).css("cursor",tool.cursor?tool.cursor:"default"),$(tool).data("button-id",$(this).attr("id"))}),$("#brush-button").click(),$(document).on("change",".wire-gauge-system",function(){var a=$(this).closest("div.ring-div");createWireGaugeList(a.data("geometry"),$(this).val()),a.find(".wire-gauge").change()}),$(document).on("change",".wire-gauge",function(){var a=$(this).closest("div.ring-div");$(this).val($(this).val()),updateAR(a.data("geometry")),geometryUpdates.add(a.data("geometry")),a.find(".aspect-ratio").change()}),$(document).on("change",".default-color",function(){var a=$(this).closest("div.ring-div");baseMaterials[a.data("geometry")].color.setStyle($(this).val()),baseMaterials[a.data("geometry")].specular&&baseMaterials[a.data("geometry")].specular.setStyle($(this).val())}),$(document).on("change",".inner-diameter, .aspect-ratio",function(){if($(this).data("value")){var a=$(this),b=$(this).closest("div.ring-div"),c=$(this).data("value"),d=$(this).val(),e=b.find(".wire-gauge-system"),f=e.data("value"),g=e.val(),h=b.find(".wire-gauge"),i=h.data("value"),j=h.val();executeCommand({execute:function(){a.val()!==d&&(e.val()!==g&&e.val(g).change(),h.val()!==j&&h.val(j),a.val(d),updateAR(b.data("geometry")))},undo:function(){a.val()!==c&&(e.val()!==f&&e.val(f).change(),h.val()!==i&&h.val(i),a.val(c),updateAR(b.data("geometry")))}})}$(this).data("value",$(this).val())}),$(document).on("input",".inner-diameter",function(){var a=$(this).closest("div.ring-div");updateAR(a.data("geometry")),geometryUpdates.add(a.data("geometry"))}),$(document).on("input",".aspect-ratio",function(){var a=$(this).closest("div.ring-div");updateID(a.data("geometry")),geometryUpdates.add(a.data("geometry"))}),$(document).on("change",".wire-material",function(){statsUpdate=!0}),$(document).on("change","input[name='units'][type='radio']",function(){units=$(this).val(),changeUnits()}),$(document).on("change",".ring-enable",function(){var a=$(this).closest("div.ring-div"),b=$(this).prop("checked");ringEnabledFlags[a.data("geometry")]=b;for(var c of ringGraph.nodes())ringGraph.node(c).geometryIndex===a.data("geometry")&&(ringGraph.node(c).mesh.material.transparent=!b,ringGraph.node(c).mesh.material.opacity=b?1:.5);$(this).next("label").removeClass(b?"fa-lock":"fa-unlock").addClass(b?"fa-unlock":"fa-lock")}),$(document).on("click","input.ring-color-button",function(a){a.preventDefault(),$("input#ring-color").val($(this).val())}),$("#save-button").click(function(a){a.preventDefault(),$.post("/datastore/save",{rings:JSON.stringify(ringGraph.nodes().map(function(a){return ringGraph.node(a)})),weave:weave.file,units:units,edgeRings:JSON.stringify(Array.from(edgeRings,function(a){return a.nodeID})),key:key?key:"",id_token:id_token},function(a){console.log(a),window.location.pathname.endsWith(a)||(window.location.pathname.endsWith(key)?window.location.pathname=window.location.pathname.replace(key,a):window.location.pathname+=a);
})});var h=window.location.pathname.split("/").filter(a=>a);h.length>1&&(key=h[1]),loadStaticData(),run()});